# CVE-2021-44228(Log4j2 CVE) 대응

## 서론
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228  
11월 말 알리바바 Cloud 쪽에서 처음 발견하여 GitHub 에 보고되어, 12월 초 Minecraft 에서 처음 보안 이슈가 발생한 Apache Log4j CVE 에 대한 내용과 대응 방법을 가볍게 정리하기로 한다.

## Apach Log4j2 RCE 취약점
Log4j2 는 Apache 에서 개발한 Java 로깅 프레임워크로, Elastic 사의 여러 솔루션 및 Kafka 에서 사용 중인 기능이다.  
프로그램 기동 중에 로그를 남기기 위해 사용하는 자바 기반의 유틸리티로 여러모로 편리한 기능인데…

이번에 Log4j 2 내에 존재하는 JNDI(Java Naming and Directory Interface) 인젝션 취약점이 발견되었고, 이를 악용할 경우 악성 코드를 실행될 취약점(RCE)이 가능해진다.

Log4j 2 의 재귀 분석 기능(recursive analysis functions) 을 악용할 경우, 공격자가 직접 악성 요청을 구성해서 원격 코드 실행 취약점을 야기할 수 있다는 것이다.

해당 취약점에 해당되는 Log4j 2 버전은 Apache Log4j 2.0-beta9 ~ 2.41.1 까지의 모든 버전이 해당되며, 취약점 수준의 심각도는 CVSS 스코어 10점으로 가장 높은 심각도이기 때문에, 빠른 대응이 필요하다.

## 대응 방법
### Log4j 2 대응법
1. Apache Log4j 업데이트
해당 취약점에 대한 패치가 적용된 버전(2.15)으로 업데이트한다.
https://logging.apache.org/log4j/2.x/download.html

2. 버전별 취약점 보완 조치
만약 Log4j 업데이트가 어려운 상황이라면, 버전별로 다음의 설정을 변경하여 임시적인 조치를 취할 수 있다.
#### 버전 ~2.10.0
문제가 되는 JndiLookiup 클래스를 경로에서 제거한다.
```
zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
```

#### 버전 2.10 ~ 2.14.1
log4j2.formatMsgNoLookups 설정을 변경해준다.
```
java -Dlog4j2.formatMsgNoLookups=true -jar myapp.jar
```

또는, LOG4J_FORMAT_MSG_NO_LOOKUPS 환경변수 값을 true 로 변경해준다.

### 관련 솔루션의 경우
#### Elastic Stack
Elastic 사 측에서 위의 Log4j2 패치를 포함한 버전을 릴리즈한다고 한다(현재 12/13 오전, 12/13 릴리즈 예정).  
버전별로 6 점대는 6.8.21, 7 점대는 7.16.1 을 릴리즈하며, 5 점대는 조사중이다.

Logstash 의 경우, 적용된 최신 버전 JDK 의 경우 취약성 노출 가능성이 매우 크기 때문에 패치 업그레이드가 필수적이다.  
Elasticsearch 의 경우, 원격 코드 실행에 노출되지는 않지만 잠재적 문제를 해결하기 위해서는 업그레이드를 추천한다.  
Kibana 의 경우 로깅 설정에 Log4j 를 사용하지는 않지만, Elasticsearch 의 버전 업그레이드가 이루어질 경우 버전 호환을 위해 함께 업그레이드할 필요가 있다.

#### Kafka
Kafka 는 기본적으로 Log4j 버전이 낮기 때문에 해당 취약점 이슈에는 해당되지 않는 것으로 보인다(log4j 버전 : 1.2.17).

다만, Kafka 에서 사용하는 Log4j 1.x 버전에도 JNDI 를 사용할 수 있는 JMS Appender 가 포함되어 있다.  
물론 Log4j 1.x 버전에는 Lookup 기능이 없으므로 JMS Appender 는 원격 서버에서 문자열만 로드하고 직렬화된 개체는 로드하지 않는다.  
정리하자면, Log4j 1.x 버전은 해당 응용 프로그램(Kafka)가 JNDI 를 사용할 경우 영향을 받을 수는 있으나, 위험도는 훨씬 낮다는 것.  

근데 Log4j 는 어찌됐든 낮은 버전이기 때문에 해당 취약성을 떠나서 다른 문제가 발생할 가능성이 높으니 잉번 기회에 패치까지 설치된 2.15.0 으로 업그레이드 하는 것이 좋다고 한다.

#### 솔루션별 Log4j 버전 확인 방법
보통 패키지에 포함된 jar 파일에 버전까지 적혀있으므로 해당 디렉토리에서 확인한다.
```
### Elastic Stack(Debian Package)
ls -altr /usr/share/<솔루션명>/lib | grep log4j

### Kafka(Archived)
ls -altr <인스톨 경로>/libs | grep log4j
```

## 참고
### Log4j 관련
* https://blog.alyac.co.kr/4341 
* https://xetown.com/topics/1636343
* https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/
### Elastic Stack 관련
* https://discuss.elastic.co/t/apache-log4j2-remote-code-execution-rce-vulnerability-cve-2021-44228-esa-2021-31/291476
* https://github.com/elastic/elasticsearch/issues/81618
### Kafka 관련
* https://stackoverflow.com/questions/70315574/which-version-of-kafka-are-impacted-due-to-log4j-cve-2021-44228/70316177
* https://github.com/apache/logging-log4j2/pull/608
